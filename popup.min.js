!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():t()}(this,function(){"use strict";function e(e){this.properties=e.properties,this.template=e.template,this.maskEle=null,this.containerEle=null,this.is_control_group=!1,this.msg={$sf_msg_title:"",$sf_msg_content:"",$sf_msg_image_url:"",$sf_succeed:"",$sf_fail_reason:"",$sf_msg_id:"",plan:{}},this.popupCheckInstance=null}var t={sa:{},info:{},lib_version:"0.2.2",defaultPara:{platform:"H5"},serverData:{},localData:{global_popup_count:[],local_update_time:null,eventQueue:[]},eventRule:{},convertPlans:[],isRun:!1,isVisible:!0,log:function(){function e(e){var t={};if(e&&"[object Object]"===Object.prototype.toString.call(e)){for(var n in e)n&&"popup_window_content"!==n&&(t[n]=e[n]);return JSON.stringify(t,null,"  ")}return e}if(t.info.show_log===!0&&"object"==typeof console&&"function"==typeof console.log)try{return arguments[0]=e(arguments[0]),arguments[1]=e(arguments[1]),console.log.apply(console,arguments)}catch(n){console.log(arguments[0])}}};!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){function e(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){return t.reject(n)})})}function t(e){return!(!e||"undefined"==typeof e.length)}function n(){}function i(e){if(!(this instanceof i))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],l(e,this)}function o(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,i._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var i;try{i=n(e._value)}catch(o){return void a(t.promise,o)}r(t.promise,i)}else(1===e._state?r:a)(t.promise,e._value)})):e._deferreds.push(t)}function r(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof i)return e._state=3,e._value=t,void s(e);if("function"==typeof n)return void l(function(e,t){return function(){e.apply(t,arguments)}}(n,t),e)}e._state=1,e._value=t,s(e)}catch(o){a(e,o)}}function a(e,t){e._state=2,e._value=t,s(e)}function s(e){2===e._state&&0===e._deferreds.length&&i._immediateFn(function(){e._handled||i._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;n>t;t++)o(e,e._deferreds[t]);e._deferreds=null}function l(e,t){var n=!1;try{e(function(e){n||(n=!0,r(t,e))},function(e){n||(n=!0,a(t,e))})}catch(i){if(n)return;n=!0,a(t,i)}}var u=setTimeout;i.prototype["catch"]=function(e){return this.then(null,e)},i.prototype.then=function(e,t){var i=new this.constructor(n);return o(this,new function(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}(e,t,i)),i},i.prototype["finally"]=e,i.all=function(e){return new i(function(n,i){function o(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var s=t.then;if("function"==typeof s)return void s.call(t,function(t){o(e,t)},i)}r[e]=t,0==--a&&n(r)}catch(l){i(l)}}if(!t(e))return i(new TypeError("Promise.all accepts an array"));var r=Array.prototype.slice.call(e);if(0===r.length)return n([]);for(var a=r.length,s=0;r.length>s;s++)o(s,r[s])})},i.resolve=function(e){return e&&"object"==typeof e&&e.constructor===i?e:new i(function(t){t(e)})},i.reject=function(e){return new i(function(t,n){n(e)})},i.race=function(e){return new i(function(n,o){if(!t(e))return o(new TypeError("Promise.race accepts an array"));for(var r=0,a=e.length;a>r;r++)i.resolve(e[r]).then(n,o)})},i._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){u(e,0)},i._unhandledRejectionFn=function(e){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var c=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();"Promise"in c?c.Promise.prototype["finally"]||(c.Promise.prototype["finally"]=e):c.Promise=i});var n={visibility:function(e){e=e||{};var t={hidden:void 0,visibilityChange:void 0,isSupported:function(){return"undefined"!=typeof this.hidden},_visible:e.onVisible,_hidden:e.onHidden,_nativeSwitch:function(){document[this.hidden]===!0?this._hidden():this._visible()},listen:function(){try{this.isSupported()?document.addEventListener(this.visibilityChange,function(){t._nativeSwitch.apply(t,arguments)},1):document.addEventListener?(window.addEventListener("foucus",this._visible,1),window.addEventListener("blur",this._hidden,1)):(document.attachEvent("onfocusin",this._visible),document.attachEvent("onfocusout",this._hidden))}catch(e){}},init:function(){"undefined"!=typeof document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(this.hidden="mozHidden",this.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(this.hidden="msHidden",this.visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"),this.listen()}};t.init()},getRgba:function(e){return"object"!=typeof e?e:"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},conversionNum:function(e){if(e){if(/^[0|1]?\.\d+$/.test(e))return 100*Number(e)+"%";var t=/^(-?\d+(\.\d+)?)px$/.exec(e);return t?(Number(t[1])/375*window.screen.width).toFixed(2)+"px":e}},boxModel:function(e){return function(t){if("object"!=typeof t)return e+":"+t+";";var i="";for(var o in t)i+=e+"-"+o+":"+n.conversionNum(t[o])+";";return i}},localStorage:{get:function(e){return window.localStorage.getItem(e)},parse:function(e){var t=null;try{t=JSON.parse(n.localStorage.get(e))||null}catch(i){}return t},set:function(e,t){window.localStorage.setItem(e,t)},remove:function(e){window.localStorage.removeItem(e)},isSupport:function(){var e=!0;try{var t="__sensorsdatasupport__",i="testIsSupportStorage";n.localStorage.set(t,i),n.localStorage.get(t)!==i&&(e=!1),n.localStorage.remove(t)}catch(o){e=!1}return e}},addEvent:function(){function e(t){return t&&(t.preventDefault=e.preventDefault,t.stopPropagation=e.stopPropagation,t._getPath=e._getPath),t}function t(t,n,i){var o=function(o){if(o=o||e(window.event)){o.target=o.srcElement;var r,a,s=!0;return"function"==typeof i&&(r=i(o)),a=n.call(t,o),!1!==r&&!1!==a||(s=!1),s}};return o}e._getPath=function(){var e=this,t=function(){try{var t=e.target,n=[t];if(null===t||null===t.parentElement)return[];for(;null!==t.parentElement;)t=t.parentElement,n.unshift(t);return n}catch(i){return[]}};return this.path||this.composedPath&&this.composedPath()||t()},e.preventDefault=function(){this.returnValue=!1},e.stopPropagation=function(){this.cancelBubble=!0};var n=function(n,i,o){if(n&&n.addEventListener)n.addEventListener(i,function(t){t._getPath=e._getPath,o.call(this,t)},!1);else{var r="on"+i,a=n[r];n[r]=t(n,o,a)}};n.apply(null,arguments)},extend:function(e){var t=Array.prototype.slice;return n.each(t.call(arguments,1),function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])}),e},each:function(e,t,n){var i=Array.prototype.forEach,o={};if(null==e)return!1;if(i&&e.forEach===i)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,a=e.length;r<a;r++)if(r in e&&t.call(n,e[r],r,e)===o)return!1}else for(var s in e)if(hasOwnProperty.call(e,s)&&t.call(n,e[s],s,e)===o)return!1},xhr:function(e){if(e)return"undefined"!=typeof window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?new XMLHttpRequest:"undefined"!=typeof XDomainRequest?new XDomainRequest:null;if("undefined"!=typeof window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}},ajax:function(e){function t(e){if(!e)return"";try{return JSON.parse(e)}catch(t){return{}}}e.timeout=e.timeout||2e4,e.credentials="undefined"==typeof e.credentials||e.credentials;var i=n.xhr(e.cors);if(!i)return!1;e.type||(e.type=e.data?"POST":"GET"),e=n.extend({success:function(){},error:function(){}},e);try{"object"==typeof i&&"timeout"in i?i.timeout=e.timeout:setTimeout(function(){i.abort()},e.timeout+500)}catch(o){try{setTimeout(function(){i.abort()},e.timeout+500)}catch(r){}}i.onreadystatechange=function(){try{4==i.readyState&&(i.status>=200&&i.status<300||304==i.status?e.success(t(i.responseText)):e.error(t(i.responseText),i.status),i.onreadystatechange=null,i.onload=null)}catch(n){i.onreadystatechange=null,i.onload=null}},i.open(e.type,e.url,!0);try{if(e.credentials&&(i.withCredentials=!0),n.isObject(e.header))for(var a in e.header)i.setRequestHeader(a,e.header[a]);e.data&&(e.cors||i.setRequestHeader("X-Requested-With","XMLHttpRequest"),"application/json"===e.contentType?i.setRequestHeader("Content-type","application/json; charset=UTF-8"):i.setRequestHeader("Content-type","application/x-www-form-urlencoded"))}catch(o){}i.send(e.data||null)},getUuid:function(){var e=function(){for(var e=1*new Date,t=0;e==1*new Date;)t++;return e.toString(16)+t.toString(16)},t=function(){return Math.random().toString(16).replace(".","")};return function(){var n=e()+"-"+t()+"-"+t();return n?n:(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15)}},trim:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},isEmptyObject:function(e){var t=Object.prototype.hasOwnProperty;if(n.isObject(e)){for(var i in e)if(t.call(e,i))return!1;return!0}return!1},filter:function(e,t,n){var i=Object.prototype.hasOwnProperty;if(e.filter)return e.filter(t);for(var o=[],r=0;r<e.length;r++)if(i.call(e,r)){var a=e[r];t.call(n,a,r,e)&&o.push(a)}return o},isObject:function(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"==Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"==Object.prototype.toString.call(e)},isBoolean:function(e){return"[object Boolean]"==Object.prototype.toString.call(e)},isNumber:function(e){return"[object Number]"==Object.prototype.toString.call(e)&&/[\d\.]+/.test(String(e))},isFunction:function(e){if(!e)return!1;try{return/^\s*\bfunction\b/.test(e)}catch(t){return!1}},getURLSearchParams:function(e){e=e||"";for(var t=function(e){return decodeURIComponent(e)},n={},i=e.substring(1),o=i.split("&"),r=0;r<o.length;r++){var a=o[r].indexOf("=");if(a!==-1){var s=o[r].substring(0,a),l=o[r].substring(a+1);s=t(s),l=t(l),n[s]=l}}return n},URL:function(e){var t={},i=["hash","host","hostname","href","origin","password","pathname","port","protocol","search","username"],o=function(){var e;try{return e=new URL("http://modernizr.com/"),"http://modernizr.com/"===e.href}catch(t){return!1}};if("function"==typeof window.URL&&o())t=new URL(e),t.searchParams||(t.searchParams=function(){var e=n.getURLSearchParams(t.search);return{get:function(t){return e[t]}}}());else{var r=/^https?:\/\/.+/;if(r.test(e)===!1)throw"Invalid URL";var a=document.createElement("a");a.href=e;for(var s=i.length-1;s>=0;s--){var l=i[s];t[l]=a[l]}t.hostname&&"string"==typeof t.pathname&&0!==t.pathname.indexOf("/")&&(t.pathname="/"+t.pathname),t.searchParams=function(){var e=n.getURLSearchParams(t.search);return{get:function(t){return e[t]}}}()}return t}};t._=n;var i={close:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAMAAAAPdrEwAAAAe1BMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////NgkbwAAAAKHRSTlMA5if6t/B0UjMSxpAtJB4MBfTr30oY6NjV0r2loZ6XkoaBenFp3UA/LNePaQAAAsxJREFUWMOsltlygzAMRRXMZsAsAZJmX9v6/7+wg1QXpjGxCDkvyWTIQZauDcCgzKLrPtnUSyGW9SbZX6OshDcQh36lH6j8MJ7pTZd6lGX6sr0IP7SDj7CA6chLoBkEFzm14nM1/P/2eGti1RZFq+LmdtwGw7afJ1Ue1dogcGCW4QptqCO2OPe1IbnL0Y7dE23wc2bJgSn44MFTvIMwLeMUXqZGfGKUkp+MPC2dwUjMGhWwUL7pnXRUsdbIIpow84VG1k9Xmf1e5U8Kq/R/68memAPqcggTCQUNc9SdL+iCL5jMd0B1j/RErh3LYrRyLa2po2x8KngJ9Uk5sWUwpZoVvIiiulNLhMwgHDhDED2MEH8X3zCDL4HV/R8lRTOEWYS0KWzt8GEm/mNLihpHKOeqJY6yLqDnbO42F1r9eXCzitMOfkuqfvkXTId6h1phSi5/ncbgneAtnDCAxTAzIn+POhfDFOObzAEsNLu0HXO06a4BCwd89wEk1h2ezdwl0rObvS5nNreHurg/lxKwsNPoHjXrHVhI+lMK3xjvMH4YelYzCSzc8V3zrx9CWtu5MG67eWEdhBSmI+GT7eIZt+Nny7YJ+y8ON9/cF1tWVL7LzTdTi6sSMtw9AE432wwl7u6MzqotMNwcM7Glc/TafRyB4+aa4dhdcoV993EDlptphlt3zZ72TgM8N88MDe3vDQWE5V6tWGaKyAbwqaiA5+aZQeETkk6QFtxuvhlaOkVwwxfgdq/IvHKbocBj6ac5OzYCIASBKGo10n+HBgakMswbaYDgTmX3fzgafhD4G+Hhg1cGXnT4PMFHVayCdVcBXGBu7cKwACOOC2YwTsIQ7KI7LBywJrlyByupK9Kw/lto4VFLAqLdmRwJiBDWwjDOI0QPPhPXRn3yTlyrILND4w7oOw3h5AlTPk5U/ddrZSk4RWW+C9hp2rgru6GiP/678n2UFPV1AAAAAElFTkSuQmCC"},o={row:"div",column:"div",label:"pre",image:"img",button:"button",link:"button",image_button:"img"},r={textAlign:"text-align",font:"font-size",backgroundColor:"background-color",borderWidth:function(e){return"border-width: "+e+";border-style: solid;"},borderColor:"border-color",cornerRadius:"border-radius",backgroundImage:function(e){return"background-image:url("+e+") no-repeat;"},margin:n.boxModel("margin"),padding:n.boxModel("padding"),maxHeight:"max-height",maxWidth:"max-width"};e.prototype={constructor:e,render:function(){var e=this,i=document.querySelector("div[data-sf-mask]");return!i&&e.loadHeadImage(e.template).then(function(i){var o=e.msg.plan.plan_id||"",r=e.msg.plan.is_control_group;if(n.extend(e.msg,i),!e.properties||!e.template)return e.popupFailed(1001),Promise.reject();if(e.template.isRoot=!0,e.containerEle=e.createView(e.template),r)return e.popupFailed(2e3),Promise.reject();if(e.maskEle=e.getElement({nodeName:"div",style:e.getStyle({position:"fixed",width:"100%",height:"100%",top:"0px",left:"0px",backgroundColor:n.getRgba(e.properties.maskColor),"z-index":999998})}),n.addEvent(e.maskEle,"click",function(n){var i=n.target,o=i.getAttribute("data-ele-mask");return o&&e.properties.maskCloseEnabled?(t.track.maskClick(e),!1):void t.track.elementClickCallback(n,e)}),e.maskEle.setAttribute("data-sf-mask",!0),e.maskEle.appendChild(e.containerEle),window.self===window.top)document.body.appendChild(e.maskEle);else try{window.top.document.body.appendChild(e.maskEle)}catch(a){document.body.appendChild(e.maskEle)}return e.msg.$sf_succeed=!0,t.track.popupDisplay(e),t.info.popup_listener.onLoadSuccess(o),Promise.resolve()},function(t){return n.extend(e.msg,t),e.popupFailed(1e3),Promise.reject()})},popupFailed:function(e){var n={1e3:"\u56fe\u7247\u52a0\u8f7d\u5931\u8d25",1001:"\u9884\u89c8\u4fe1\u606f\u89e3\u6790\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u8ba1\u5212\u914d\u7f6e",2e3:"\u5bf9\u7167\u7ec4"},i=this.msg.plan.plan_id||"",o=n[e];this.msg.$sf_succeed=!1,this.msg.$sf_fail_reason=o,t.track.popupDisplay(this),2e3!==e&&t.info.popup_listener.onLoadFailed(i,e,o)},getElement:function(e){var t=e.nodeName||"div",i=e.style,o=e.attr,r=e.child,a=e.action,s=e.element_info,l=document.createElement(t);return i&&l.setAttribute("style",i),o&&n.each(o,function(e,t){e&&(l[t]=e)}),r&&r.length&&n.each(r,function(e){return!!e&&void l.appendChild(e)}),a&&a.H5&&a.H5.length&&l.setAttribute("data-action",JSON.stringify(a.H5)),s&&l.setAttribute("data-info",JSON.stringify(s)),l},getStyle:function(e){var t="",i=["msgType","text","image","name","isHidden","align","localImageName"];return n.each(e,function(e,o){var e=n.conversionNum(e),a=r[o];return!(i.indexOf(o)>=0)&&void(t+=n.isString(a)?a+":"+n.getRgba(e)+";":n.isFunction(a)?a(e)+";":o+":"+n.getRgba(e)+";")}),t},createView:function(e){var t=[],r={"box-sizing":"border-box",display:"block","pointer-events":"auto",overflow:"hidden"},a={},s=o[e.type]||null;e.properties=e.properties||{},e.layout=e.layout||{};var l=e.properties.font,u=l?1.7*parseInt(l)+"px":"normal";if(e.properties.isHidden)return!1;switch(e.properties.text?a.innerText=e.properties.text:e.properties.image&&(e.properties.localImageName?a.src=i[e.properties.localImageName]:a.src=e.properties.image),e.isRoot&&(e.layout.margin="auto",n.extend(r,{position:"relative","z-index":999999,"pointer-events":"none"})),e.type){case"row":r.display="flex";break;case"link":n.extend(r,{"text-decoration":"underline",outline:"none","letter-spacing":"1px","line-height":u});break;case"label":n.extend(r,{"white-space":"pre-wrap","word-wrap":"break-word","letter-spacing":"1px","line-height":u});break;case"button":n.extend(r,{outline:"none","letter-spacing":"1px","line-height":u})}n.extend(r,e.layout,e.properties),e.subviews&&e.subviews.length>0&&n.each(e.subviews,function(e){t.push(this.createView(e))},this);var c=this.getElement({element_info:{$sf_msg_element_type:e.type,$sf_msg_element_content:e.properties.text||""},nodeName:s,attr:a,style:this.getStyle(r),child:t,action:e.action});if(e.layout.align){var p={center:"center",left:"flex-start",right:"flex-end"},d=document.createElement("div"),r="display:flex;justify-content:"+p[e.layout.align]+";";return e.isRoot?(r+="width:100%;height:100%;overflow-y:auto;box-sizing: border-box;align-items:center;",d.setAttribute("style",r),d.setAttribute("data-ele-mask",!0)):d.setAttribute("style",r),d.appendChild(c),d}return c},destory:function(){var e=this.msg.plan.plan_id||"";if(window.self===window.top)document.body.removeChild(this.maskEle);else try{window.top.document.body.removeChild(this.maskEle)}catch(n){document.body.removeChild(this.maskEle)}t.info.popup_listener.onClose(e),this.popupCheckInstance&&this.popupCheckInstance.resetPopupIntervalWindow()},loadHeadImage:function(e){function t(e){n.each(e.subviews,function(e){var n=e.properties;return!!n&&("title"===n.msgType?i.$sf_msg_title=n.text:"content"===n.msgType?i.$sf_msg_content=n.text:"image"===e.type&&(i.$sf_msg_image_url=n.image),void(e.subviews&&t(e)))})}var i={$sf_msg_image_url:"",$sf_msg_title:"",$sf_msg_content:""};return t(e),i.$sf_msg_image_url?new Promise(function(e,t){var n=new Image;n.src=i.$sf_msg_image_url,n.onload=function(){e(i)},n.onerror=function(){t(i)},n.onabort=function(){t(i)}}):Promise.resolve(i)}},t.track={getPublicProps:function(e){var i=e.plan,o={$sf_lib_version:t.lib_version,$sf_plan_type:"\u8fd0\u8425\u8ba1\u5212",$sf_channel_service_name:"SENSORS_FOCUS",$sf_channel_category:"POPUP",$sf_platform_tag:t.info.platform,$sf_msg_id:e.$sf_msg_id};return n.isEmptyObject(i)?o:(o.$sf_plan_id=i.plan_id+"",o.$sf_plan_strategy_id=i.is_control_group?"-1":"0",i.audience_id&&(o.$sf_audience_id=i.audience_id+""),o)},removeEmpty:function(e){n.each(e,function(t,n){""!==t&&void 0!==t||delete e[n]})},popupDisplay:function(e){var i=t.track.getPublicProps(e.msg),o={$sf_msg_title:e.msg.$sf_msg_title,$sf_msg_content:e.msg.$sf_msg_content,$sf_msg_image_url:e.msg.$sf_msg_image_url,$sf_succeed:e.msg.$sf_succeed,$sf_fail_reason:e.msg.$sf_fail_reason};n.extend(o,i),this.removeEmpty(o),t.sa.track("$PlanPopupDisplay",o)},popupClick:function(e,i){var o=t.track.getPublicProps(i.msg);n.extend(e,o),this.removeEmpty(e),t.sa.track("$PlanPopupClick",e)},maskClick:function(e){if(!e.msg)return!1;var i=t.track.getPublicProps(e.msg),o={$sf_close_type:"POPUP_CLOSE_MASK",$sf_msg_title:e.msg.$sf_msg_title,$sf_msg_content:e.msg.$sf_msg_content,$sf_msg_image_url:e.msg.$sf_msg_image_url,$sf_msg_element_type:"mask",$sf_msg_action_id:e.properties.maskActionId};n.extend(o,i),this.removeEmpty(o),t.track.popupClick(o,e),e.destory()},elementClickCallback:function(e,i){var o=e.target,r=o.getAttribute("data-action"),a=o.getAttribute("data-info"),s=i.msg||{};if(!r)return!1;try{var l=JSON.parse(r)||{},u=l[0],c=JSON.parse(a)||{}}catch(e){t.log("elementClickCallback error",e)}var p={type:u.type,value:n.isString(u.value)?u.value:"",extra:n.isObject(u.value)?u.value:""},d=i.msg.plan?i.msg.plan.plan_id:"",f={$sf_msg_title:s.$sf_msg_title,$sf_msg_content:s.$sf_msg_content,$sf_msg_image_url:s.$sf_msg_image_url,$sf_msg_element_type:c.$sf_msg_element_type,$sf_msg_element_content:c.$sf_msg_element_content,$sf_msg_element_action:u.type,$sf_msg_action_id:u.id};if("close"===u.type){f.$sf_close_type=u.$sf_close_type,t.track.popupClick(f,i);try{t.info.popup_listener.onClick(d,p)}catch(e){t.log("popup_listener.onClick error",e)}i.destory()}else{t.track.popupClick(f,i);try{t.info.popup_listener.onClick(d,p)}catch(e){t.log("popup_listener.onClick error",e)}if(u.closeable?i.destory():null,"auto"===t.info.popup_listener.openlink&&"openlink"===u.type){if("http"!==u.value.slice(0,4))return!1;window.location.href=u.value}}}},t.testSend={hasParam:function(){var e=n.URL(window.location.href).searchParams,t=e.get("sf_popup_test")||"",i=e.get("popup_window_id")||"";return!(!t||!i)&&{sf_popup_test:t,popup_window_id:i}},start:function(){var i=t.info.project,o=this.hasParam().popup_window_id;return!!o&&void n.ajax({url:t.info.api_base_url+"/sfo/popup_windows/"+o+"?project="+encodeURIComponent(i)+"&time="+(new Date).getTime(),type:"GET",credentials:!1,cors:!0,contentType:"application/json",success:function(t){if(!t||!t.content)return!1;var i=JSON.parse(t.content),o=n.getUuid(),r=new e(i);r.msg.$sf_msg_id=o,r.render()}})}},t.isSupportPopup=function(){return n.localStorage.isSupport()},t.listenPageStateChange=function(){var e=!0;n.visibility({onVisible:function(){t.log("\u9875\u9762\u89e6\u53d1visible-",(new Date).getMinutes(),"\u5206",(new Date).getSeconds()),e===!1&&(t.updateDataAndSetListen.startState(),e=!0)},onHidden:function(){t.log("\u9875\u9762\u89e6\u53d1hidden-",(new Date).getMinutes(),"\u5206",(new Date).getSeconds()),e===!0&&(t.updateDataAndSetListen.stopAllState(),e=!1)}})},t.getWebSDK=function(){return!!(n.isObject(window.sensorsDataAnalytic201505)&&n.isObject(window.sensorsDataAnalytic201505.readyState)&&window.sensorsDataAnalytic201505.readyState.state>=3)&&window.sensorsDataAnalytic201505},t.setPara=function(e){n.isObject(e)||(e={}),t.info=n.extend({},t.defaultPara,e),t.sa=this.getWebSDK();var i=t.sa;if(!i)return t.log("web js sdk \u8fd8\u6ca1\u6709\u521d\u59cb\u5316\u5b8c\u6210"),!1;if(!n.isString(t.info.api_base_url)||"http"!==t.info.api_base_url.slice(0,4))return t.log("popup \u5fc5\u987b\u586b\u5199\u6709\u6548 api_base_url"),!1;if("http:"===t.info.api_base_url.slice(0,5)&&"https:"===location.protocol)return t.log("\u60a8\u7684\u5f53\u524d\u9875\u9762\u662fhttps\u7684\u5730\u5740\uff0capi_base_url \u4e5f\u5fc5\u987b\u662fhttps\uff01"),!1;if(t.info.api_base_url="/"===t.info.api_base_url.slice(-1)?t.info.api_base_url.slice(0,-1):t.info.api_base_url,t.info.project||(t.info.project=n.URL(i.para.server_url).searchParams.get("project")||"default"),n.isObject(t.info.popup_listener)){var o=t.info.popup_listener;n.isFunction(o.onClick)||(t.info.popup_listener.onClick=function(){}),n.isFunction(o.onLoadSuccess)||(t.info.popup_listener.onLoadSuccess=function(){}),n.isFunction(o.onLoadFailed)||(t.info.popup_listener.onLoadFailed=function(){}),n.isFunction(o.onClose)||(t.info.popup_listener.onClose=function(){}),n.isString(o.openlink)?"auto"!==o.openlink&&"customize"!==o.openlink&&(t.info.popup_listener.openlink="customize"):t.info.popup_listener.openlink="customize"}else t.info.popup_listener={onClick:function(){},onLoadSuccess:function(){},onLoadFailed:function(){},onClose:function(){},openlink:"customize"};return!0},t.setIsLoad=function(){var e=window.self===window.top;if(e){if(window.SensorsDataWebJSSDKPopupIsLoad)return!1;if("undefined"==typeof window.SensorsDataWebJSSDKPopupIsLoad)return window.SensorsDataWebJSSDKPopupIsLoad=!0,!0}else try{return!window.top.SensorsDataWebJSSDKPopupIsLoad&&(window.top.SensorsDataWebJSSDKPopupIsLoad=!0,!0)}catch(n){return t.log("\u975e\u540c\u57df\u540diframe\u5185\u5d4c\u4e0d\u80fd\u83b7\u53d6\u7236\u7ea7\u7a97\u4f53\u5185\u5bb9",n),!0}},t.init=function(e){return!!this.isSupportPopup()&&(!(window.screen.width&&Number(window.screen.width)>1024)&&(!!this.setPara(e)&&(!!this.setIsLoad()&&void(t.testSend.hasParam()?t.testSend.start():(t.listenPageStateChange(),t.updateDataAndSetListen.initial())))))};var a=t.log;return t.changeCovertStatus=function(e){var i=JSON.parse(JSON.stringify(t.convertPlans));n.each(i,function(i,o){if(!i.is_in_convert_window)return!1;var r=i.is_in_convert_window.step,a=i.is_in_convert_window.uuid;return t.convertPlans[o].is_in_convert_window.step=Math.min(2*r,6e5),!!e&&void n.each(e,function(e){e.popup_display_uuid===a&&e.convert_time&&(delete t.convertPlans[o].is_in_convert_window,t.convertPlans.splice(o,1))})})},t.asyncConvert=function(e){function i(){if(n.isEmptyObject(t.localData)||!n.isArray(t.convertPlans)||0===t.convertPlans.length)return!1;var e=JSON.parse(JSON.stringify(t.convertPlans)),r=e[0].is_in_convert_window&&e[0].is_in_convert_window.step||5e3,a=[];return n.each(e,function(e,n){if(!e.is_in_convert_window)return!1;var i=(new Date).getTime(),o=e.is_in_convert_window.expire_time;return i>o?(delete t.convertPlans[n].is_in_convert_window,t.convertPlans.splice(n,1),!1):(a.push(e.is_in_convert_window.uuid),e.is_in_convert_window.step||(e.is_in_convert_window.step=5e3,t.convertPlans[n].is_in_convert_window.step=5e3),void(r>e.is_in_convert_window.step&&(r=e.is_in_convert_window.step)))}),!!a.length&&(t.asyncConvert.timer&&clearTimeout(t.asyncConvert.timer),void(t.asyncConvert.timer=setTimeout(function(){n.ajax({url:t.info.api_base_url+"/sfo/popup_displays?project="+encodeURIComponent(o)+"&popup_display_uuids="+encodeURIComponent(a)+"&time="+(new Date).getTime(),type:"GET",cors:!0,credentials:!1,contentType:"application/json",success:function(e){t.changeCovertStatus(e),i()},error:function(){t.changeCovertStatus(),i()}})},r)))}var o=t.info.project,r=!1;return!(!e&&0===t.convertPlans.length)&&(e&&(n.each(t.convertPlans,function(t){t.plan_id===e.plan_id&&(r=!0)}),r||t.convertPlans.push(e)),void i())},t.ruleTime={getExpire:function(e,t){var n=t,i=Number(e.value)||0,o=Number(e.value)||0,r=String(e.unit).toLowerCase(),a=null,s={day:function(){return a=new Date(n),a.setHours(23),a.setMinutes(59),a.setSeconds(59),a.setMilliseconds(999),a=a.getTime()+864e5*o},week:function(){a=new Date(n);var e=a.getDay();0===e&&(e=7);var t=7-e;return a.setHours(23),a.setMinutes(59),a.setSeconds(59),a.setMilliseconds(999),a=a.getTime()+24*t*60*60*1e3+7*o*24*60*60*1e3},month:function(){a=new Date(n);var e=a.getMonth(),t=e+o;return t>=11?(a.setFullYear(a.getFullYear()+parseInt(t/11)),a.setMonth(t%11)):a.setMonth(t),a.setDate(1),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.getTime()},second:function(e){var t={month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},o=null;return a=new Date(n),e in t&&(o=t[e]*i),a.getTime()+o}};return e.natural!==!0?s.second(r):r in s?s[r]():void 0},getLast:function(e,t){var n=Number(e.value)||0,i=Number(e.value)-1||0,o=String(e.unit).toLowerCase(),r=null,a={day:function(){return r=new Date(t),r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),r=r.getTime()-864e5*i},week:function(){r=new Date(t);var e=r.getDay();return 0===e&&(e=7),--e,r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),r=r.getTime()-(24*e*60*60*1e3+7*i*24*60*60*1e3)},month:function(){r=new Date(t);var e=r.getMonth()+1,n=e-i;return n<=0?(r.setFullYear(r.getFullYear()+(parseInt(n/12)-1)),r.setMonth(12+n%12-1)):r.setMonth(n-1),r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),r.getTime()},second:function(e){var i={month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},o=null;return r=new Date(t),e in i&&(o=i[e]*n),r.getTime()-o}};return e.natural!==!0?a.second(o):o in a?a[o]():void 0},getArrMatchCount:function(e,t){var n=0;for(n=0;n<e.length;n++)if(t>=e[n])return n;return e.length},checkRule:function(e,t){var n=new Date,i=t,o=Number(e.value)||0,r=Number(e.value)-1||0,a=String(e.unit).toLowerCase(),s=null,l={day:function(){return s=new Date(i),s.setHours(23),s.setMinutes(59),s.setSeconds(59),s.setMilliseconds(999),s=s.getTime()+864e5*r,n>s},week:function(){s=new Date(i);var e=s.getDay();0===e&&(e=7);var t=7-e;return s.setHours(23),s.setMinutes(59),s.setSeconds(59),s.setMilliseconds(999),s=s.getTime()+24*t*60*60*1e3+7*r*24*60*60*1e3,n>s},month:function(){s=new Date(i);var e=s.getMonth(),t=e+r;return t>=11?(s.setFullYear(s.getFullYear()+t/11),s.setMonth(t%11)):s.setMonth(t),s.setDate(1),s.setHours(0),s.setMinutes(0),s.setSeconds(0),s.setMilliseconds(0),n>s},second:function(e){var t={month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},r=null;return s=new Date(i),e in inteval&&(interval_time=t[e]*o),n>s+r}};return e.natural!==!0?l.second(a):a in l?l[a]():void 0}},t.eventTriggerProcess=function(){if(!t.isVisible)return!1;if(!n.isArray(t.localData.eventQueue))return!1;if(0===t.localData.eventQueue.length)return!1;if(t.isRun)return!1;a("\u4e8b\u4ef6\u961f\u5217---eventQueue",t.localData.eventQueue);var e=!1,i=t.localData.eventQueue[0],o=t.eventRule[i.event];if(t.isRun=!0,t.localData.eventQueue.shift(),n.isArray(o)&&n.isObject(o[0])&&o.length>0){a("--------------------\u89e6\u53d1\u4e8b\u4ef6\u5f00\u59cb--------------------"),n.each(o,function(e){n.isObject(e)&&"undefined"!=typeof e.match_state&&delete e.match_state,new t.RuleCheck(e,i)});var r=!1;n.each(o,function(n){n.match_state===!0?e===!1?(e=!0,r=!0,a("\u68c0\u67e5\u5b8c\u6bd5-\u4f18\u5148\u5f39\u7a97-\u5f00\u59cb",n.plan.cname),new t.PopupCheck(n,(!0))):e===!0&&(a("\u68c0\u67e5\u5b8c\u6bd5-\u975e\u4f18\u5148\u5f39\u7a97-\u4e0d\u6e32\u67d3",n.plan.cname),new t.PopupCheck(n,(!1))):a("\u68c0\u67e5\u5b8c\u6bd5-\u8ba1\u5212-\u4e0d\u6ee1\u8db3",n.plan.cname)}),r||t.completeWindowLifecycle(),a("--------------------\u89e6\u53d1\u4e8b\u4ef6\u7ed3\u675f--------------------")}},t.completeWindowLifecycle=function(){t.isRun=!1,t.eventTriggerProcess()},t.PopupCheck=function(e,t){this.plan=e.plan,this.current_time=(new Date).getTime(),t?this.renderPopup():this.hidePopup()},t.PopupCheck.prototype.createPopupWindow=function(e,n){this.startConvertWindow(e),this.startPopupIntervalWindow(),this.startPopupLimitWindow(),this.setGlobalLimit(),this.deletePlanAllWindow(),n&&t.completeWindowLifecycle()},t.PopupCheck.prototype.hidePopup=function(){this.deletePlanAllWindow()},t.PopupCheck.prototype.renderPopup=function(){var t=this,i=n.getUuid()(),o=this.plan.popup_window_content;if(!o||!o.content)return!1;try{var r=JSON.parse(o.content),s=new e(r)}catch(l){t.createPopupWindow(i,!0),a("--\u5f39\u7a97\u5c55\u793a-\u6e32\u67d3\u9519\u8bef",l)}s.msg.plan=this.plan,s.msg.$sf_msg_id=i,s.popupCheckInstance=this,a("--\u5f39\u7a97\u5c55\u793a-\u662f\u5426\u662f\u5bf9\u7167\u7ec4",this.plan.is_control_group),s.render().then(function(){t.createPopupWindow(i)},function(){t.createPopupWindow(i,!0)})},t.PopupCheck.prototype.startConvertWindow=function(e){a("--\u5f39\u7a97\u5c55\u793a-\u8f6c\u5316\u7a97\u53e3\u8bbe\u7f6e"),n.isObject(this.plan.convert_window)&&this.plan.convert_window.value&&(this.plan.is_in_convert_window={expire_time:t.ruleTime.getExpire(this.plan.convert_window,this.current_time),uuid:e},t.asyncConvert(this.plan))},t.PopupCheck.prototype.startPopupIntervalWindow=function(){n.isObject(this.plan.popup_interval)&&this.plan.popup_interval.value&&(this.plan.is_in_popup_interval_window=t.ruleTime.getExpire(this.plan.popup_interval,this.current_time))},t.PopupCheck.prototype.resetPopupIntervalWindow=function(){var e=(new Date).getTime();n.isObject(this.plan.popup_interval)&&this.plan.popup_interval.value&&(this.plan.is_in_popup_interval_window=t.ruleTime.getExpire(this.plan.popup_interval,e)),this.resetGlobalLimit(e),t.completeWindowLifecycle()},t.PopupCheck.prototype.startPopupLimitWindow=function(){a("--\u5f39\u7a97\u5c55\u793a-\u53c2\u4e0e\u9650\u5236\u7a97\u53e3\u8bbe\u7f6e\u91cd\u7f6e"),n.isObject(this.plan.re_enter)&&this.plan.re_enter.value&&(n.isObject(this.plan.is_in_popup_limit_window)?this.plan.is_in_popup_limit_window.count++:this.plan.is_in_popup_limit_window={expire_time:t.ruleTime.getExpire(this.plan.re_enter,this.current_time),count:1})},t.PopupCheck.prototype.setGlobalLimit=function(){a("--\u5f39\u7a97\u5c55\u793a-\u5168\u5c40\u5f39\u7a97\u6b21\u6570\u8bbe\u7f6e"),n.isArray(t.localData.global_popup_count)||(t.localData.global_popup_count=[]),t.localData.global_popup_count.unshift(this.current_time);for(var e=t.localData.global_popup_count,i=e[e.length-1];i+7776e6<this.current_time||e.length>3e3;)e.pop(),i=e[e.length-1]},t.PopupCheck.prototype.resetGlobalLimit=function(e){n.isArray(t.localData.global_popup_count)&&t.localData.global_popup_count.length>0&&(t.localData.global_popup_count.shift(),t.localData.global_popup_count.unshift(e))},t.PopupCheck.prototype.deletePlanAllWindow=function(){var e=this.plan.pattern_popup.matcher_list;n.isArray(e)&&n.each(e,function(e){e.is_in_window&&(a("--\u5f39\u7a97\u5c55\u793a-\u91cd\u7f6e\u5404\u4e2a\u89c4\u5219\u7684\u7a97\u53e3\u8ba1\u7b97-\u6210\u529f"),delete e.is_in_window)})},t.RuleCheck=function(e,t){this.plan_match=e,this.plan=e.plan,this.rule_arr=e.rule,this.event_data=t,this.current_time=(new Date).getTime();
var i="-------------\u68c0\u67e5-\u8ba1\u5212-("+this.plan.cname+")";n.each(this.rule_arr,function(e){i+="--\u5305\u542b\u89c4\u5219-("+e.event_name+"\uff09-\u89e6\u53d1"+e.params[0]+"\u6b21"}),a(i),a(this.plan),this.checkPlanIsExpire()},t.RuleCheck.prototype.checkPlanIsExpire=function(){!this.plan.expire_at||n.isNumber(this.plan.expire_at)&&this.current_time<this.plan.expire_at?(a("--\u8fc7\u671f-\u6ee1\u8db3"),this.checkPlanIsAudience()):a("--\u8fc7\u671f-\u4e0d\u6ee1\u8db3")},t.RuleCheck.prototype.checkPlanIsAudience=function(){this.plan.is_audience===!0?(a("--\u662f\u5426\u53d7\u4f17-\u6ee1\u8db3"),this.checkPlanSuspend()):a("--\u662f\u5426\u53d7\u4f17-\u4e0d\u6ee1\u8db3")},t.RuleCheck.prototype.checkPlanSuspend=function(){this.plan.status&&"SUSPEND"===this.plan.status?a("--\u6682\u505c-\u4e0d\u6ee1\u8db3"):(a("--\u6682\u505c-\u6ee1\u8db3"),this.checkConvert())},t.RuleCheck.prototype.checkConvert=function(){if(n.isObject(this.plan.is_in_convert_window)&&this.plan.is_in_convert_window.expire_time>this.current_time)a("--\u5b58\u5728\u8f6c\u5316\u7a97\u53e3 - \u4e0d\u6ee1\u8db3",this.plan.is_in_convert_window);else if(n.isObject(this.plan.is_in_convert_window)&&this.current_time>this.plan.is_in_convert_window.expire_time){a("--\u8f6c\u5316\u7a97\u53e3\u8d85\u65f6\u5df2\u7ecf\u8fc7\u671f - \u6ee1\u8db3",this.plan.is_in_convert_window),delete this.plan.is_in_convert_window;for(var e=0;e<t.convertPlans.length;e++)this.plan.plan_id===t.convertPlans[e].plan_id&&(t.convertPlans.splice(e,1),e--);this.checkGlobalPopupInterval()}else a("--\u4e0d\u5b58\u5728\u8f6c\u5316\u7a97\u53e3 - \u6ee1\u8db3",this.plan.is_in_convert_window),this.checkGlobalPopupInterval()},t.RuleCheck.prototype.checkGlobalPopupInterval=function(){var e=t.localData.global_popup_count;if(n.isArray(e)&&e.length>=1){var i=t.ruleTime.getLast(t.localData.popup_interval_global,this.current_time);i>e[0]?(a("--\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u6ee1\u8db3-"+i+">\u4e0a\u6b21\u5f39\u7a97\u65f6\u95f4"+e[0]),this.checkPopupInterval()):a("\u68c0\u67e5-\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u4e0d\u6ee1\u8db3-"+i+"<\u4e0a\u6b21\u5f39\u7a97\u65f6\u95f4"+e[0])}else a("--\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u6ca1\u6709\u5f39\u8fc7\u7a97-\u6ee1\u8db3"),this.checkPopupInterval()},t.RuleCheck.prototype.checkPopupInterval=function(){n.isNumber(this.plan.is_in_popup_interval_window)?this.current_time>this.plan.is_in_popup_interval_window?(a("--\u5f39\u7a97\u95f4\u9694-\u5f53\u524d\u65f6\u95f4\u5927\u4e8e\u56fa\u5b9a\u5f39\u7a97\u95f4\u9694-\u6ee1\u8db3"),this.plan.is_in_popup_interval_window=null,this.checkProperties()):a("--\u5f39\u7a97\u95f4\u9694-\u5f53\u524d\u65f6\u95f4\u5c0f\u4e8e\u56fa\u5b9a\u5f39\u7a97\u95f4\u9694-\u4e0d\u6ee1\u8db3"):(a("--\u5f39\u7a97\u95f4\u9694-\u7a97\u53e3\u4e0d\u5b58\u5728-\u65b0\u5f00"),this.plan.is_in_popup_interval_window=null,this.checkProperties())},t.RuleCheck.prototype.checkProperties=function(){var e={equal:function(e,t){if(!n.isNumber(e)&&!n.isString(e))return!1;for(var i=0;i<t.length;i++)if(e===t[i])return!0;return!1},notEqual:function(e,t){if(!n.isNumber(e)&&!n.isString(e))return!1;for(var i=0;i<t.length;i++)if(e===t[i])return!1;return!0},contain:function(e,t){return!!n.isString(e)&&e.indexOf(t[0])>=0},notContain:function(e,t){return!!n.isString(e)&&e.indexOf(t[0])===-1},isTrue:function(e){return e===!0},isFalse:function(e){return e===!1},isSet:function(e){return void 0!==e},notSet:function(e){return void 0===e},isEmpty:function(e){if(!n.isString(e)&&!n.isArray(e))return!1;if(n.isString(e))return""===e;for(var t=0;t<e.length;t++){var i=e[t].replace(/^\s+|\s+$/g,"");if(""!==i)return!1}return!0},isNotEmpty:function(e){if(!n.isString(e)&&!n.isArray(e))return!1;if(n.isString(e))return""!==e;for(var t=0;t<e.length;t++){var i=e[t].replace(/^\s+|\s+$/g,"");if(""===i)return!1}return!0},less:function(e,t){return!!n.isNumber(e)&&e<Number(t[0])},greater:function(e,t){return!!n.isNumber(e)&&e>Number(t[0])},between:function(e,t){return!!n.isNumber(e)&&(e>=Number(t[0])&&e<=Number(t[1]))},"in":function(e,t){if(!n.isArray(e))return!1;for(var i=0;i<e.length;i++)if(t.indexOf(e[i])>=0)return!0;return!1},notInclude:function(e,t){if(!n.isArray(e))return!1;for(var i=0;i<e.length;i++)if(t.indexOf(e[i])===-1)return!0;return!1},absolute_between:function(e,t){try{var n=new Date(t[0]),i=new Date(t[1]),o=new Date(e);return o>=n&&o<=i}catch(r){a("absolute_between Error",r)}},absoluteBetween:function(e,t){try{var n=new Date(t[0]),i=new Date(t[1]),o=new Date(e);return o>=n&&o<=i}catch(r){a("absolute_between Error",r)}}},t=this,i=n.filter(this.rule_arr,function(i){if(!i.filter||i.filter.conditions&&0===i.filter.conditions.length)return!0;var o=i.filter,r=o.relation,a="or"===String(r).toLowerCase(),s="and"===String(r).toLowerCase(),l=!!s,u=!0;return n.each(o.conditions,function(n){if(!u)return!1;if(!n.field)return!1;var i=n.field.lastIndexOf("."),o=n.params,r=n["function"];if(!e[r])return l=!1,u=!1,!1;if(i<0)return!1;var c=n.field.slice(i+1),p=t.event_data.properties[c],d=e[r](p,o);a&&d&&(l=!0,u=!1),s&&!d&&(l=!1,u=!1)}),l});n.isArray(i)&&i.length>0?(this.checkWindowAndMatch(i),a("--\u5c5e\u6027\u5339\u914d-\u6ee1\u8db3",i)):a("--\u5c5e\u6027\u5339\u914d-\u4e0d\u6ee1\u8db3")},t.RuleCheck.prototype.checkWindowAndMatch=function(e){var i=this,o=[];n.each(e,function(e){if(!e.params||!e.params[0])return a("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u89c4\u5219\u6570\u636e\u5f02\u5e38"),!1;var r=Number(e.params[0]);1===r?o.push(e):r>1&&n.isObject(e.window)&&e.window.value>0&&(!n.isObject(e.is_in_window)||!n.isNumber(e.is_in_window.expire_time)||e.is_in_window.expire_time<i.current_time?e.is_in_window={expire_time:t.ruleTime.getExpire(e.window,i.current_time),count:1}:e.is_in_window.count=e.is_in_window.count+1,e.is_in_window.count>=r?o.push(e):a("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u89c4\u5219\u6570",e.is_in_window.count,"\u4e0d\u5339\u914d\u5f53\u524d\u6b21\u6570",r))}),o.length>0?(a("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u6709\u5339\u914d\u6210\u529f\u7684\u89c4\u5219",o),this.checkGlobalPopupLimit()):a("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u6ca1\u6709\u5339\u914d\u6210\u529f\u7684\u89c4\u5219",o)},t.RuleCheck.prototype.checkGlobalPopupLimit=function(){var e=t.localData.msg_limit_global,i=!0,o=this;n.isObject(e)&&e.is_in_use===!0&&n.isArray(e.limits)&&n.isArray(t.localData.global_popup_count)&&this.plan.global_msg_limit_enabled===!0?(n.each(e.limits,function(e){if(n.isObject(e)&&n.isNumber(e.limit)){var r=t.ruleTime.getLast(e,o.current_time),s=t.ruleTime.getArrMatchCount(t.localData.global_popup_count,r);a("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u5df2\u7ecf\u5f39\u7a97\u6b21\u6570-"+s+"-\u9650\u5236\u7684\u6b21\u6570"+e.limit+"-\u9650\u5236\u65f6\u95f4-"+r),i=s<e.limit?i&&!0:i&&!1}}),i?this.checkPopupLimit():a("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u4e0d\u6ee1\u8db3")):(a("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u4e0d\u6ee1\u8db3(\u53c2\u6570\u6b63\u5e38\uff0c\u5df2\u5f39\u8fc7\u7a97\uff0c\u5f53\u524d\u8ba1\u5212\u8bbe\u7f6e\u4e86\u9650\u5236)\u4e4b\u4e00 - \u6ee1\u8db3"),this.checkPopupLimit())},t.RuleCheck.prototype.checkPopupLimit=function(){return n.isObject(this.plan.re_enter)&&n.isNumber(this.plan.re_enter.value)&&n.isNumber(this.plan.re_enter.limit)?void(n.isObject(this.plan.is_in_popup_limit_window)&&n.isNumber(this.plan.is_in_popup_limit_window.expire_time)&&n.isNumber(this.plan.is_in_popup_limit_window.count)?this.plan.is_in_popup_limit_window.expire_time<this.current_time?(a("--\u53c2\u4e0e\u9650\u5236-\u8d85\u8fc7\u4e86\u53c2\u4e0e\u9650\u5236\u7a97\u53e3-\u5f00\u542f\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),delete this.plan.is_in_popup_limit_window,this.plan_match.match_state=!0):this.plan.is_in_popup_limit_window.count<this.plan.re_enter.limit?(a("--\u53c2\u4e0e\u9650\u5236-\u5728\u7a97\u53e3\u5185\u4e14\u5728\u53c2\u4e0e\u9650\u5236\u6b21\u6570\u5185-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),this.plan_match.match_state=!0):a("--\u53c2\u4e0e\u9650\u5236-\u5728\u7a97\u53e3\u5185\u4f46\u662f\u8d85\u8fc7\u4e86\u53c2\u4e0e\u9650\u5236-\u4e0d\u6ee1\u8db3",this.plan.is_in_popup_limit_window):(this.plan.is_in_popup_limit_window?(a("--\u53c2\u4e0e\u9650\u5236-\u6709\u7a97\u53e3\u4f46\u662f\u7a97\u53e3\u6570\u636e\u5f02\u5e38-\u5f00\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),delete this.plan.is_in_popup_limit_window):a("--\u53c2\u4e0e\u9650\u5236-\u4e0d\u5b58\u5728\u7a97\u53e3-\u5f00\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),this.plan_match.match_state=!0)):(this.plan_match.match_state=!0,!1)},t.store={init:function(){t.localData=this.getJSONData()||{global_popup_count:[],local_update_time:null,eventQueue:[]},n.isNumber(t.info.pull_interval_ms)?t.updateDataAndSetListen.interval_time=t.info.pull_interval_ms:n.isNumber(t.localData.config_pull_interval_ms)&&(t.updateDataAndSetListen.interval_time=t.localData.config_pull_interval_ms),t.log("\u521d\u59cb\u5316-\u83b7\u53d6-\u5185\u5b58-localData")},getJSONData:function(){return n.localStorage.parse("sensorsdata202002-popupdata")},saveJSONData:function(){n.localStorage.set("sensorsdata202002-popupdata",JSON.stringify(t.localData))}},t.updateDataAndSetListen={active_state:!0,interval_time:6e5,save_interval:null,data_interval:null,filterConvertPlans:function(){var e=t.localData.popup_plans;if(!e||!n.isArray(e))return!1;var i=n.filter(e,function(e){return!!e.convert_window&&!!e.is_in_convert_window});t.convertPlans=i,t.log("\u521d\u59cb\u5316-\u5f02\u6b65\u7684convertWindow",t.convertPlans),t.asyncConvert()},diffData:function(){var e=t.localData,i=JSON.parse(JSON.stringify(t.serverData)),o=(new Date).getTime();if(!i||n.isEmptyObject(i))return!1;var r=o-i.server_current_time;if(Math.abs(r)>=6e5)return!1;if(!e&&n.isEmptyObject(e))return n.extend(t.localData,i),!1;var a=i.popup_plans;n.each(a,function(t,i){var o=null;return n.each(e.popup_plans,function(e){e.plan_id===t.plan_id&&(o=e,o.is_audience=t.is_audience,t.audience_id?o.audience_id=t.audience_id:delete o.audience_id)}),!!o&&(o.last_update_config_time===t.last_update_config_time&&void(a[i]=o))}),n.extend(t.localData,i),t.log("\u521d\u59cb\u5316-\u6bd4\u5bf9\u6570\u636e\u5f97\u5230\u9700\u8981\u7684-localData",t.localData)},getEventRule:function(){var e=t.localData.popup_plans,i={};return!(!e||!n.isArray(e))&&(n.each(e,function(e){var t=e.pattern_popup.matcher_list;n.each(t,function(t){var o={plan:e,rule:[t]},r=t.event_name,a=!1;if(i[r]){if(n.each(i[r],function(n){n.plan.plan_id===e.plan_id&&(n.rule.push(t),a=!0)}),a)return!1;i[r].push(o)}else i[r]=[o]})}),n.each(i,function(e){e.sort(function(e,t){var n=t.plan.absolute_priority-e.plan.absolute_priority;return 0===n?t.plan.plan_id-e.plan.plan_id:n})}),t.eventRule=i,t.log("\u521d\u59cb\u5316-\u5f97\u5230\u4e8b\u4ef6\u548c\u8ba1\u5212\u7684\u5173\u7cfb"),void t.log("--------------------\u521d\u59cb\u5316\u5b8c\u6210--------------------\u7b49\u5f85\u4e8b\u4ef6\u89e6\u53d1\u8ba1\u5212--------------------"))},registerListen:function(){var e=this;t.sa.events.on("send",function(e){e.event&&t.eventRule[e.event]&&(n.isArray(t.localData.eventQueue)||(t.localData.eventQueue=[]),t.localData.eventQueue.push(e),t.eventTriggerProcess())}),t.sa.events.on("changeDistinctId",function(t){e.changeId()}),t.sa.events.isReady()},setListenEvent:function(){this.diffData(),this.filterConvertPlans(),this.getEventRule()},getDataFromServer:function(){var e=this,i=t.sa.store.getDistinctId(),o=t.info.platform,r=t.info.project;return new Promise(function(a,s){n.ajax({url:t.info.api_base_url+"/sfo/user_popup_configs/"+i+"?platform="+encodeURIComponent(o)+"&project="+encodeURIComponent(r)+"&time="+(new Date).getTime(),type:"GET",cors:!0,credentials:!1,contentType:"application/json",success:function(i){return e.active_state?(t.log("\u521d\u59cb\u5316-\u4fee\u6539-serverData-ajax\u83b7\u53d6"),void(n.isObject(i)&&i.server_current_time&&i.popup_plans&&/\d+\.\d+/.test(i.min_sdk_version_required)&&parseFloat(i.min_sdk_version_required)<=parseFloat(t.lib_version)?(t.serverData=i,t.localData.local_update_time=(new Date).getTime(),e.setListenEvent(),a(),e.setIntervalTime(e.interval_time)):(t.log("\u521d\u59cb\u5316-\u6570\u636e\u5f02\u5e38-\u8bf7\u6c42\u8fd4\u56de\u7684\u6570\u636e\u9519\u8bef-\u4e2d\u6b62"),t.serverData={},t.localData={},a()))):(s(),!1)},error:function(){return e.active_state?(t.log("\u521d\u59cb\u5316-\u6570\u636e\u5f02\u5e38-\u8bf7\u6c42\u9519\u8bef-\u4e2d\u6b62"),t.serverData={},a(),void e.setIntervalTime(e.interval_time)):(s(),!1)}})})},setIntervalTime:function(e){var n=this;this.data_interval=setTimeout(function(){t.log("10\u5206\u949f\u5b9a\u65f6\u66f4\u65b0\u6570\u636e\u5f00\u59cb-------"),n.getDataFromServer()},e)},setFirstListen:function(){var e=this;this.getDataFromServer().then(function(){e.registerListen()})},updateLocalData:function(){var e=JSON.stringify(t.localData);this.save_interval=setInterval(function(){var n=JSON.stringify(t.localData);e!==n&&(t.store.saveJSONData(),e=n)},500)},initial:function(){t.store.init(),this.updateLocalData();var e=t.localData.local_update_time,i=(new Date).getTime();if(n.isNumber(e)){var o=i-e;o<=0||o>=this.interval_time?this.setFirstListen():(this.setIntervalTime(o),this.setListenEvent(),this.registerListen())}else this.setFirstListen()},changeId:function(){this.stopAllState(),this.startState({getLocalData:!1})},stopAllState:function(){this.active_state=!1,t.eventRule={},this.data_interval&&window.clearTimeout(this.data_interval),this.save_interval&&window.clearInterval(this.save_interval),t.asyncConvert.timer&&window.clearTimeout(t.asyncConvert.timer),t.convertPlans=[],t.log("\u521d\u59cb\u5316-\u6e05\u7a7a-localData"),t.localData={},this.resetState({isHidden:!0})},resetState:function(e){t.isRun&&(t.isRun=!1),e.isHidden?t.isVisible=!1:t.isVisible=!0},startState:function(e){this.active_state=!0,e=e||{getLocalData:!0};var n=this;e.getLocalData&&(this.resetState({isHidden:!1}),t.store.init()),this.getDataFromServer().then(function(){t.store.saveJSONData(),n.updateLocalData()})}},"[object Object]"!==Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin={popup:t}:window.SensorsDataWebJSSDKPlugin.popup=window.SensorsDataWebJSSDKPlugin.popup||t,t});